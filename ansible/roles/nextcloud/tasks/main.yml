# Create User for nextcloud
- name: Create User nextcloud
  user:
    name: "{{ nextcloud_user_name }}"
    comment: User for nextcloud docker
    system: "no"
    create_home: "no"
    uid: "{{ nextcloud_user_id }}"
    group: "{{ nextcloud_group_name}}"

# Create directories
- name: Create nextcloud Directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nextcloud_user_name }}"
    group: "{{ nextcloud_group_name }}"
    seuser: "{{ se_file_user }}"
    serole: "{{ se_file_role }}"
    setype: "{{ se_file_type }}"
    recurse: "yes"
  with_items:
    - "{{ nextcloud_dirs }}"

# Copy Template
- name: Copy nginx.conf from template
  template:
    src: nginx.conf
    dest: "{{ nextcloud_nginx_dir }}/nginx.conf"
    owner: "{{ nextcloud_user_name }}"
    group: "{{ nextcloud_group_name }}"
    seuser: "{{ se_file_user }}"
    serole: "{{ se_file_role }}"
    setype: "{{ se_file_type }}"

# Create proxy network
- name: Create docker proxy network
  docker_network:
    name: proxy

# Create nextcloud_net network
- name: Create nextcloud_net network
  docker_network:
    name: nextcloud_net

# Start the nextcloud-fpm docker container
- name: Start nextcloud-fpm to serve php
  docker_container:
    name: nextcloud-fpm
    hostname: nextcloud-fpm
    image: nextcloud:fpm-alpine
    state: started
    restart_policy: unless-stopped
    volumes:
      - "{{ nextcloud_www_dir }}:/var/www/html:Z"
    networks:
      - name: nextcloud_net

# Start nextcloud-web (nginx) to serve static html content
- name: Start nextcloud-web
  docker_container:
    name: nextcloud-web
    hostname: nextcloud-web
    image: nginx:alpine
    state: started
    restart_policy: unless-stopped
    volumes:
      - "{{ nextcloud_www_dir }}:/var/www/html:ro"
      - "{{ nextcloud_nginx_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
    env:
      VIRTUAL_HOST: "{{ nextcloud_virtual_host }}"
      LETSENCRYPT_HOST: "{{ nextcloud_letsencrypt_host }}"
      LETSENCRYPT_EMAIL: "{{ nextcloud_letsencrypt_mail }}"
    networks:
      - name: proxy
      - name: nextcloud_net
